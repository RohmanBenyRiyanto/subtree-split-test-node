name: Subtree Split & Auto Publish

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

jobs:
  subtree-split:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        package:
          - name: php
            path: php
            repo: subtree-split-test-php
          - name: node
            path: node
            repo: subtree-split-test-node

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.REPO_TOKEN }}

      - name: Setup Git Config
        run: |
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "actions@github.com"

      - name: Check if Remote Repository Exists
        id: check_repo
        run: |
          REPO_OWNER="${{ github.repository_owner }}"
          REPO_NAME="${{ matrix.package.repo }}"

          echo "Checking repository: $REPO_OWNER/$REPO_NAME"

          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" \
            -H "Authorization: token ${{ secrets.REPO_TOKEN }}" \
            "https://api.github.com/repos/$REPO_OWNER/$REPO_NAME")

          if [ "$HTTP_STATUS" = "200" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "Repository exists"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "Repository does not exist"
          fi

      - name: Create Remote Repository if Not Exists
        if: steps.check_repo.outputs.exists == 'false'
        run: |
          REPO_OWNER="${{ github.repository_owner }}"
          REPO_NAME="${{ matrix.package.repo }}"
          PACKAGE_NAME="${{ matrix.package.name }}"

          echo "Creating repository: $REPO_NAME"

          # Check if owner is an organization or user
          USER_TYPE=$(curl -s -H "Authorization: token ${{ secrets.REPO_TOKEN }}" \
            "https://api.github.com/users/$REPO_OWNER" | jq -r '.type')

          if [ "$USER_TYPE" = "Organization" ]; then
            API_URL="https://api.github.com/orgs/$REPO_OWNER/repos"
          else
            API_URL="https://api.github.com/user/repos"
          fi

          curl -X POST "$API_URL" \
            -H "Authorization: token ${{ secrets.REPO_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            -d '{
              "name": "'"$REPO_NAME"'",
              "description": "Auto-generated '"$PACKAGE_NAME"' package from monorepo",
              "private": false,
              "auto_init": false
            }'

          echo "Repository created successfully"
          sleep 5

      - name: Split Subtree and Push
        run: |
          REPO_OWNER="${{ github.repository_owner }}"
          REPO_NAME="${{ matrix.package.repo }}"
          PACKAGE_PATH="${{ matrix.package.path }}"
          BRANCH="${{ github.ref_name }}"

          echo "Splitting $PACKAGE_PATH to $REPO_NAME..."

          # Create temporary branch for subtree
          TEMP_BRANCH="split-${{ matrix.package.name }}-$(date +%s)"

          # Split subtree
          git subtree split --prefix="$PACKAGE_PATH" -b "$TEMP_BRANCH"

          # Push to remote repository
          git push -f "https://${{ secrets.REPO_TOKEN }}@github.com/$REPO_OWNER/$REPO_NAME.git" \
            "$TEMP_BRANCH:$BRANCH"

          # Cleanup temporary branch
          git branch -D "$TEMP_BRANCH"

          echo "Successfully pushed $PACKAGE_PATH to $REPO_NAME"

      - name: Create Release Tag (if tagged)
        if: startsWith(github.ref, 'refs/tags/')
        run: |
          REPO_OWNER="${{ github.repository_owner }}"
          REPO_NAME="${{ matrix.package.repo }}"
          TAG_NAME="${{ github.ref_name }}"

          echo "Creating tag $TAG_NAME in $REPO_NAME..."

          # Get the commit SHA from the subtree
          COMMIT_SHA=$(git rev-parse HEAD)

          # Create tag in remote repository
          curl -X POST \
            -H "Authorization: token ${{ secrets.REPO_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/$REPO_OWNER/$REPO_NAME/git/refs" \
            -d '{
              "ref": "refs/tags/'"$TAG_NAME"'",
              "sha": "'"$COMMIT_SHA"'"
            }'

          echo "Tag $TAG_NAME created in $REPO_NAME"

  publish-npm:
    needs: subtree-split
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - name: Checkout Node Package
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository_owner }}/subtree-split-test-node
          token: ${{ secrets.REPO_TOKEN }}
          ref: ${{ github.ref_name }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          registry-url: "https://registry.npmjs.org"

      - name: Publish to NPM
        run: |
          npm publish --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        continue-on-error: true

  publish-composer:
    needs: subtree-split
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - name: Checkout PHP Package
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository_owner }}/subtree-split-test-php
          token: ${{ secrets.REPO_TOKEN }}
          ref: ${{ github.ref_name }}

      - name: Validate Composer
        run: |
          composer validate --no-check-all --strict
        continue-on-error: true

      - name: Note about Packagist
        run: |
          echo "Packagist will auto-detect new tags if repository is registered"
          echo "Register at: https://packagist.org/packages/submit"
